name: Build and Deploy Backend to ECS

on:
  push:
    branches: [main, production]
    paths:
      - 'server/**'
      - 'infra/Dockerfile.backend.prod'
      - 'pnpm-lock.yaml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: backend
  ECS_CLUSTER: app-builder-cluster
  ECS_SERVICE: backend-service
  ECS_TASK_DEFINITION: backend-task

jobs:
  validate-and-build:
    name: Validate Dependencies and Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Validate Docker dependencies
        run: pnpm validate:docker
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            -f infra/Dockerfile.backend.prod \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
      
      - name: Test Docker container
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Start container
          docker run -d \
            -p 3000:3000 \
            --name test-backend \
            -e NODE_ENV=production \
            -e PORT=3000 \
            $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          # Wait for startup
          sleep 10
          
          # Test health endpoint
          curl -f http://localhost:3000/health || exit 1
          
          # Check logs for errors
          docker logs test-backend
          
          # Verify no "Cannot find module" errors
          if docker logs test-backend 2>&1 | grep -q "Cannot find module"; then
            echo "❌ ERROR: Module not found errors detected"
            docker logs test-backend
            exit 1
          fi
          
          # Cleanup
          docker stop test-backend
          docker rm test-backend
      
      - name: Verify no symlinks in image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Check for symlinks (should be empty)
          SYMLINKS=$(docker run --rm $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG find /app/node_modules -type l)
          
          if [ -n "$SYMLINKS" ]; then
            echo "❌ ERROR: Symlinks found in container"
            echo "$SYMLINKS"
            exit 1
          fi
          
          echo "✅ No symlinks found (good!)"
      
      - name: Push to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
      
      - name: Update ECS task definition
        id: task-def
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Get current task definition
          TASK_DEFINITION=$(aws ecs describe-task-definition \
            --task-definition $ECS_TASK_DEFINITION \
            --query 'taskDefinition' \
            --output json)
          
          # Update image in task definition
          NEW_TASK_DEF=$(echo $TASK_DEFINITION | jq \
            --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" \
            '.containerDefinitions[0].image = $IMAGE | 
             del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')
          
          # Register new task definition
          NEW_TASK_INFO=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "task-definition-arn=$NEW_TASK_INFO" >> $GITHUB_OUTPUT
      
      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --task-definition ${{ steps.task-def.outputs.task-definition-arn }} \
            --force-new-deployment
      
      - name: Wait for deployment
        run: |
          echo "Waiting for ECS service to stabilize..."
          aws ecs wait services-stable \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE
      
      - name: Verify deployment
        run: |
          # Get service status
          SERVICE_STATUS=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].deployments[0].rolloutState' \
            --output text)
          
          echo "Deployment status: $SERVICE_STATUS"
          
          if [ "$SERVICE_STATUS" != "COMPLETED" ]; then
            echo "❌ Deployment failed"
            exit 1
          fi
          
          echo "✅ Deployment successful"
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Build or deployment failed"
          echo "Check logs above for details"
          # Add Slack/email notification here if needed

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: validate-and-build
    if: failure()
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Rollback ECS service
        run: |
          echo "Rolling back to previous task definition..."
          
          # Get previous task definition
          PREVIOUS_TASK_DEF=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].deployments[1].taskDefinition' \
            --output text)
          
          if [ -n "$PREVIOUS_TASK_DEF" ]; then
            aws ecs update-service \
              --cluster $ECS_CLUSTER \
              --service $ECS_SERVICE \
              --task-definition $PREVIOUS_TASK_DEF \
              --force-new-deployment
            
            echo "✅ Rolled back to $PREVIOUS_TASK_DEF"
          else
            echo "⚠️  No previous task definition found"
          fi
